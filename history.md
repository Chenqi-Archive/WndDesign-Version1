## 设计历史与问题



这个图形界面库算是我的第一个练手的项目，今年（2020年）暑假开始系统地设计和编写，大概花了两个多月的时间完成，当然如果算上之前的各种尝试经历，以及参考各种资料的时间的话，大概用了半年多的时间。

图形界面库自然不是我首要想完成的项目，本来是想做一些实用的小软件，但现有的图形界面库实在不好用，就不得不自己造这个轮子。之前虽然说学过编程，但以算法为主，完全没有接触过GUI和软件项目。因为想做这个项目，我在寒假的时候才第一次接触Win32编程，记得当时在B站看VC驿站的教学视频，还了解了一点MFC框架，不过当时也在网上一查资料，发现MFC已经太老旧了，而且也十分臃肿，就没有再深入学下去。

之后我就自己开始封装Win32的API，打算写一个能用的图形框架。取名叫WndDesign，是因为当时还想做一个可以在运行时编辑图形界面的工具出来，而且感觉也不太困难。但其实那时的设计思路还十分简单，因为我当时完全没有任何项目经验，c++经验也仅限于课上学的，能写一些简单的算法，知道类和对象，但c++的各种特性，包括STL、异常、模版、还有很多新特性，完全不熟。不过因为之前见过一些工程大概长什么样子，就试着利用头文件进行接口封装，风格类似C语言，甚至还手写过一些基础的数据结构比如链表、句柄分配表等等。在早期因为结构还比较简单，我反复重构迭代过很多次，但因为设计的问题，还是没有继续做下去。不过当时的代码都保存着。如果大家感兴趣，可以找我获取，或许可以拿来参考吧。

根据代码记录和我的记忆，我当时的思路大约是，为每个窗口创建一块bitmap（就直接new一片32位RGBA的数组），在这个bitmap上直接把图形画出来，比如一条直线，一个圆，就用参数方程一个个像素点地画，如果有子窗口，就递归地把子窗口的bitmap复制到父窗口上，最后再把根窗口画好的bitmap搬到HDC上，就算完成了。当时还把动画封装成了简单的对象形式，每个图形对象维护它所要画的bitmap，动画就定时在它的bitmap上画，计时器还是异步的。可以猜想这样画的效率极低。后来为了提高效率，考虑到子窗口可以直接画在父窗口的bitmap上，我就为每个窗口分配了一个可以画图的“画板”，就是bitmap上面的一个矩形区域，从而一块bitmap可以创建多个虚拟的画板。不过在绘制每个像素点时还要作坐标变换，效率就更低了。

关于窗口的维护，我一开始也是仿照Windows的形式，建立一个全局的窗口句柄表，发送消息时就根据窗口句柄，向对应的窗口注册的MsgHandler发送这个消息。每一个根窗口都对应着一个Win32的HWND，与根窗口有关的消息就直接转发给了Win32的处理函数。

我当时还打算设置不同的窗口类型，比如没有子窗口的窗口FinalWnd，子窗口不能重叠的窗口TileWnd（从而子窗口可以直接画在父窗口的bitmap上），子窗口可以重叠的窗口OverlapWnd（需要为子窗口单独提供bitmap），以及可以滚动的窗口ScrollWnd等等，还有一些窗口控件比如按钮等。因为可以滚动的窗口需要一块巨大的bitmap，我就只能把它分成小块，绘制时再把坐标转换为小块bitmap的坐标，但在实际设计ScrollWnd时就完全走不动了，由于还要绘制滚动条、边框之类的部分，由于设计架构的原因，这些组件的关系十分复杂，完全理不清楚了。

做不下去的另一个原因是文本的绘制。我当时还花了一个星期的时间，参考官方的文档以及其他人的代码，自己解析TTF字体文件把一个对应字符的轮廓画在bitmap上，并输出bmp文件，但之后看到TTF字体文件中还有各种参数，甚至需要解析指令，任务量巨大，就完全不想继续做了。之后这个项目就告一段落。

总之，以上这些准备和试错，都是在暑假之前做的，此时这个代码库还没有开始真正构建。不过这时我开始逐渐体会到了软件工程的很多繁琐的细节和复杂的架构设计和权衡。



虽然之后没有继续做这个项目，不过我依然在留意一些其他项目的设计，打算边学习别人的设计思路边找灵感。我还是不打算直接使用别人的图形界面库。一些简单的图形库，比如easyx之类的，相当于只是封装了一下Win32的API，代码风格接近c语言，名字还有各种复杂的大写前缀，非常不方便，用c++的namespace不好吗？一些较复杂的图形库，比如Qt，则已经发展了数十年，变得无比庞大臃肿，虽然尝试过但总觉得难以接近。一些图形库喜欢用XML等标记语言定义样式，我则觉得可以但没有太大必要，而且多种语言格式会比较混乱。微软的WPF也很想尝试，但我对C#不熟，也暂时不想再学一门新的语言，用c++就完全可以做到。Web框架，比如Electron就更庞大了，我也曾简单了解过html，js，css三件套但不是很熟悉，而且感觉自己想要做的项目用web写可能效率会很低，而且会非常不方便，就只是打算了解一下。

之后的一大部分时间我都在查Chromium内核设计有关的各种资料，学习浏览器是如何工作的，有哪些组成部分，各个进程如何分工，如何从dom树变成渲染树，将样式呈现出来。不过没有深入阅读代码，实在是太复杂了，但通过读一些简单的代码我也收获不少，不过主要是关于代码风格和设计思想的。



暑假我就开始打算重新设计图形界面库。图形库就是要提供一个方便的上层用户接口，可以直接定义样式，而不用关心各个像素位置，关于样式的定义我参考了大量css属性，大多数样式属性的命名都与css保持一致。底层的接口使用微软的Direct2D，DirectWrite等库，这样可以免去大量工作，还支持GPU加速。之后便开始看微软的文档，熟悉这些库的接口，写了一些小的测试样例。

最麻烦的地方在于窗口层级的组织，以及窗口的绘图部分。之前的问题，比如一个超大的滚动区域如何高效实现，是在这次设计中首要考虑的问题。这些设计工作大约花了几周时间，主要在7月份完成，用的是OneNote。OneNote是个非常方便的工具，可以在二维平面上任意位置写字，随意拖动，也可以用笔画手写，这些特性对于需要频繁变动的早期设计来说及其重要，之前的设计我是用纸笔做的，效率比用OneNote差一大截。这部分的设计工作的细节还在OneNote里保存，如果感兴趣可以联系我。

写代码实现的工作从7月底开始做，期间还有大量的设计调整，到8月底主要的部分就完成了，9月份开始进一步封装，提供面向对象接口，写了一些简单的控件比如文本编辑框，表格等等。并且初步实现了我之前的一些想法。

之后又发现设计存在巨大的问题，另外随着对c++风格的逐渐熟悉，一些设计模式逐渐固定下来，就打算重构之前混乱不堪的代码，同时也便于添加一些新功能。

新的WndDesign正在建构中，请参考WndDesign代码库。